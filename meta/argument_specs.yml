---
# Copyright 2015, Jean-Philippe Evrard <jean-philippe@evrard.me>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

argument_specs:
  main:
    short_description: "This role installs keepalived and configures it."
    version_added: 6.0.1
    description:
      - This role installs keepalived and configures it according to the variables you'll pass to the role.
    author:
      - Jean-Philippe Evrard <jean-philippe@evrard.me> (@evrardjp)
    options:
      keepalived_show_ansible_managed: 
        type: bool
        default: False
        description:
          - Wheter to add 'ansible_managed' information on top of keepalived.conf
      keepalived_selinux_compile_rules:
        type: list
        elements: str
        default:
          - keepalived_ping
          - keepalived_setpgid
        description:
          - If running keepalived with SELinux, you could need to compile your
          - rules. Please override this list with path to files to compile.
      keepalived_use_latest_stable:
        type: bool
        description:
          - true evaluates to latest - false evaluates to present
      keepalived_package_state:
        type: str
        choices:
          - latest
          - present
        default:
          - "( (keepalived_use_latest_stable | default(true)) | bool) | ternary('latest','present')"
        description:
          - keepalived package state
      keepalived_scripts_packages:
        type: list
        elements: str
        description:
          - Keepalived scripts may rely upon additional packages.
      cache_timeout:
        type: int
        default:
          - 600
        description:
          - This is the expiration time of your package manager cache.
          - When expired, this role will require to update the package manger cache.
          - This variable will be removed when the ansible upstream bugs will be fixed.
      keepalived_instances:
        type: dict
        description:
          - keepalived instances definitins
      keepalived_sync_groups:
        type: dict
        description:
          - keepalived sync groups definitions
      keepalived_bind_on_non_local:
        type: bool
        default: False
        description:
          - sysctl enable bind on non local IP
      keepalived_sysctl_tcp_retries:
        type: int
        default: 8
        description:
          - In case of VIP failover some applications might stuck on retrying to send
          - data without updating ARP. This variable defines amount of retries kernel
          - will send before consider connection as dead. It will influence on VIP
          - failover speed directly. Default sysctl value is 15 which result in
          - ~13 minutes of recovery. 8 retires is minimum according to RFC 1122 and
          - results in 100 seconds for timeout. Oracle suggest a value of 3 for a RAC
          - configuration which might be too agressive for some scenarios.
      keepalived_global_defs:
        type: list
        elements: str
        description:
          - This list of strings will appear in the global_defs section of the
          - keepalived configuration file.
          - "Example:"
          - "  keepalived_global_defs:"
          - "    - enable_script_security"
      keepalived_systemd_overrides:
        type: bool
        default: True
        description:
          - "Whether to add systemd overrides for keepalived:"
          - "  Wants=network-online.target"
          - "  After=network-online.target"
      keepalived_systemd_override_service_restart:
        type: bool
        default: False
        description:
          - Whether to add systemd option Restart=always
          - It depends on bool keepalived_systemd_overrides, so to add both must be True
# FAILED! => {"msg": "'_keepalived_daemon_options_file_path' is undefined"}
# this is how it is defined in defaults/main.yml - argument_specs does not know about /vars/*.yml
# alternative entry point does not work atm. -> https://github.com/ansible/ansible/issues/75456
#      keepalived_daemon_options_file_path:
#        type: str
#        default: "_keepalived_daemon_options_file_path"
#        description:
#          - Set location of keepalived daemon options file path
#          - This is included into the vars/*.yml
#          - For Debian based systems it's usually /etc/default/keepalived
#          - For RedHat based systems it's usually /etc/sysconfig/keepalived
      keepalived_daemon_default_options_overrides:
        type: list
        elements: str
        description:
          - Overriding keepalived daemon extra arguments, which will be applied inside of
          - the keepalived_daemon_options_file_path variable.
          - "Example:"
          - "  keepalived_daemon_default_options_overrides:"
          - "    - \"DAEMON_ARGS='--snmp'\""
      keepalived_flush_configuration:
        type: bool
        default: False
        description:
          - Remove all keepalived configurations
          - Clears entire 'keepalived_config_directory_path'

# WELL... https://github.com/ansible/ansible/issues/75456
#  create_configuration:
#    short_description: "configuration"
#    options:
#      keepalived_daemon_options_file_path:
#        type: str
#        default: "_keepalived_daemon_options_file_path"
#        description:
#          - Set location of keepalived daemon options file path
#          - This is included into the vars/*.yml
#          - For Debian based systems it's usually /etc/default/keepalived
#          - For RedHat based systems it's usually /etc/sysconfig/keepalived
#
